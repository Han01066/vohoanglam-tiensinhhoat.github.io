<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tính tiền sinh hoạt — Ăn uống, Điện, Nước, Tiền phòng</title>
    <style>
        :root {
            --bg: #f6f7fb;
            --card: #ffffff;
            --accent: #2563eb;
            --muted: #6b7280
        }

        body {
            font-family: Inter, system-ui, Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 24px;
            color: #111
        }

        .container {
            max-width: 980px;
            margin: 0 auto
        }

        header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 18px
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(16, 24, 40, 0.06);
            padding: 18px
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center
        }

        label {
            font-size: 13px;
            color: var(--muted)
        }

        input,
        select {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e6e9ef;
            font-size: 14px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #eef2f7;
            text-align: left
        }

        th {
            font-size: 13px;
            color: var(--muted)
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        button {
            background: var(--accent);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            cursor: pointer
        }

        button.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid rgba(37, 99, 235, 0.12)
        }

        .small {
            font-size: 13px;
            padding: 6px 10px
        }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        .totals {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px
        }

        .tot-card {
            background: #fafbff;
            padding: 12px;
            border-radius: 10px;
            min-width: 180px
        }

        .right {
            text-align: right
        }

        .danger {
            color: #ef4444
        }

        @media (max-width:700px) {
            .row {
                flex-direction: column;
                align-items: stretch
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Tính tiền sinh hoạt — tháng / khoảng ngày cụ thể</h1>
            <div class="muted">Nhập ngày bắt đầu và kết thúc để tính cho khoảng thời gian bạn muốn (ví dụ: 01/12/2025 -
                31/12/2025)</div>
        </header>

        <div class="card">
            <form id="periodForm" onsubmit="return false">
                <div class="row" style="align-items:center;justify-content:space-between;">
                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                        <div>
                            <label for="startDate">Ngày bắt đầu</label><br>
                            <input type="date" id="startDate" required />
                        </div>
                        <div>
                            <label for="endDate">Ngày kết thúc</label><br>
                            <input type="date" id="endDate" required />
                        </div>
                        <div>
                            <label for="currency">Đơn vị tiền</label><br>
                            <select id="currency">
                                <option value="VND">VND</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>

                    <div class="actions">
                        <button id="calcBtn" class="small">Tính tổng</button>
                        <button id="resetBtn" type="button" class="small ghost">Xoá dữ liệu</button>
                        <button id="exportBtn" type="button" class="small ghost">Xuất CSV</button>
                        <button id="printBtn" type="button" class="small ghost">In / Lưu PDF</button>
                    </div>
                </div>

                <hr style="margin:12px 0;border:0;border-top:1px solid #eef2f7" />

                <!-- Section: Các mục chi tiêu -->
                <h3 style="margin:8px 0">Các mục chi tiêu</h3>
                <div class="muted">Bạn có thể thêm nhiều dòng cho mỗi loại (ăn uống, điện, nước, tiền phòng...)</div>

                <div style="margin-top:12px">
                    <table id="itemsTable">
                        <thead>
                            <tr>
                                <th>Loại</th>
                                <th>Mô tả</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thời điểm / Ghi chú</th>
                                <th style="width:90px">Thành tiền</th>
                                <th style="width:70px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- row template inserted by JS -->
                        </tbody>
                    </table>

                    <div style="display:flex;gap:8px;margin-top:8px">
                        <select id="quickType">
                            <option value="Ăn uống">Ăn uống</option>
                            <option value="Điện">Điện</option>
                            <option value="Nước">Nước</option>
                            <option value="Tiền phòng">Tiền phòng</option>
                            <option value="Khác">Khác</option>
                        </select>
                        <input id="quickDesc" placeholder="Mô tả (ví dụ: ăn trưa, tiền phòng tháng 12)" />
                        <input id="quickQty" type="number" min="0" step="1" placeholder="Số lượng"
                            style="width:110px" />
                        <input id="quickPrice" type="number" min="0" step="0.01" placeholder="Đơn giá"
                            style="width:140px" />
                        <input id="quickNote" placeholder="Ngày/ghi chú" style="width:160px" />
                        <button id="addBtn" type="button" class="small">Thêm</button>
                    </div>
                </div>

                <div class="totals">
                    <div class="tot-card">
                        <div class="muted">Tổng (Ăn uống)</div>
                        <div id="sumFood">0</div>
                    </div>
                    <div class="tot-card">
                        <div class="muted">Tổng (Điện)</div>
                        <div id="sumElectric">0</div>
                    </div>
                    <div class="tot-card">
                        <div class="muted">Tổng (Nước)</div>
                        <div id="sumWater">0</div>
                    </div>
                    <div class="tot-card">
                        <div class="muted">Tổng (Tiền phòng)</div>
                        <div id="sumRent">0</div>
                    </div>
                    <div class="tot-card" style="flex:1">
                        <div class="muted">Tổng chung</div>
                        <div id="sumTotal" style="font-weight:700;font-size:18px">0</div>
                        <div class="muted" id="perDayText"></div>
                    </div>
                </div>

            </form>
        </div>

        <div style="height:18px"></div>

        <div class="card">
            <h3 style="margin:0 0 8px 0">Lịch sử chi tiết</h3>
            <div class="muted">Danh sách các mục bạn đã thêm sẽ hiển thị ở đây; có thể sửa/xoá từng dòng.</div>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Ngày</th>
                        <th>Loại</th>
                        <th>Mô tả</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div style="height:40px"></div>

        <footer class="muted">Ghi chú: giá trị không cố định; chương trình này chỉ phục vụ tính toán cá nhân.</footer>
    </div>

    <script>
        // Helper: format number according to currency
        function fmt(n, currency) {
            if (isNaN(n) || n === null) return '-';
            if (currency === 'VND') return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(n);
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(n);
        }

        // App state
        const items = [];

        const tableBody = document.querySelector('#itemsTable tbody');
        const historyBody = document.querySelector('#historyTable tbody');

        // Create a new empty row in table (used when adding)
        function createRow(item, index) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${escapeHtml(item.type)}</td>
        <td>${escapeHtml(item.desc)}</td>
        <td>${item.qty}</td>
        <td>${fmt(item.price, item.currency)}</td>
        <td>${escapeHtml(item.note)}</td>
        <td class="right">${fmt(item.qty * item.price, item.currency)}</td>
        <td><button class="small ghost" data-i="${index}" onclick="removeItem(event)">Xoá</button></td>
      `;
            return tr;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, function (m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[m] });
        }

        // Render lists
        function render() {
            tableBody.innerHTML = ''; historyBody.innerHTML = '';
            items.forEach((it, i) => {
                tableBody.appendChild(createRow(it, i));
                const r = document.createElement('tr');
                r.innerHTML = `<td>${escapeHtml(it.date || '')}</td><td>${escapeHtml(it.type)}</td><td>${escapeHtml(it.desc)}</td><td>${it.qty}</td><td>${fmt(it.price, it.currency)}</td><td>${fmt(it.qty * it.price, it.currency)}</td><td><button class=\"small ghost\" onclick=\"editItem(${i})\">Sửa</button></td>`;
                historyBody.appendChild(r);
            });
        }

        function removeItem(e) {
            const i = Number(e.currentTarget.dataset.i);
            if (isNaN(i)) return;
            items.splice(i, 1);
            render();
            calculateSums();
        }

        window.editItem = function (i) {
            const it = items[i];
            if (!it) return;
            document.getElementById('quickType').value = it.type;
            document.getElementById('quickDesc').value = it.desc;
            document.getElementById('quickQty').value = it.qty;
            document.getElementById('quickPrice').value = it.price;
            document.getElementById('quickNote').value = it.note || '';
            // remove original and let user re-add
            items.splice(i, 1);
            render();
            calculateSums();
        };

        document.getElementById('addBtn').addEventListener('click', () => {
            const type = document.getElementById('quickType').value;
            const desc = document.getElementById('quickDesc').value || type;
            const qty = Number(document.getElementById('quickQty').value) || 1;
            const price = Number(document.getElementById('quickPrice').value) || 0;
            const note = document.getElementById('quickNote').value || '';
            const currency = document.getElementById('currency').value || 'VND';
            // attach date from period if provided
            const date = document.getElementById('startDate').value || '';
            items.push({ type, desc, qty, price, note, currency, date });
            document.getElementById('quickDesc').value = ''; document.getElementById('quickQty').value = ''; document.getElementById('quickPrice').value = ''; document.getElementById('quickNote').value = '';
            render(); calculateSums();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (!confirm('Bạn có chắc muốn xoá tất cả dữ liệu trong bảng?')) return;
            items.length = 0; render(); calculateSums();
        });

        document.getElementById('calcBtn').addEventListener('click', () => {
            if (!validateDates()) return;
            calculateSums();
            alert('Đã tính xong — xem phần Tổng chung.');
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (items.length === 0) { alert('Không có dữ liệu để xuất.'); return }
            const csv = toCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'living_expenses.csv'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('printBtn').addEventListener('click', () => {
            window.print();
        });

        function toCSV() {
            const rows = [['Ngày', 'Loại', 'Mô tả', 'Số lượng', 'Đơn giá', 'Đơn vị', 'Ghi chú', 'Thành tiền']];
            items.forEach(it => rows.push([it.date || '', it.type, it.desc, it.qty, it.price, it.currency, it.note, (it.qty * it.price)]));
            return rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
        }

        function validateDates() {
            const sd = document.getElementById('startDate').value;
            const ed = document.getElementById('endDate').value;
            if (!sd || !ed) { alert('Vui lòng nhập đủ ngày bắt đầu và ngày kết thúc.'); return false }
            if (new Date(sd) > new Date(ed)) { alert('Ngày bắt đầu phải trước hoặc bằng ngày kết thúc.'); return false }
            return true;
        }

        function calculateSums() {
            // ensure dates valid for per-day calculation
            const currency = document.getElementById('currency').value || 'VND';
            let sumFood = 0, sumElectric = 0, sumWater = 0, sumRent = 0, sumTotal = 0;
            items.forEach(it => {
                const v = (Number(it.qty) || 0) * (Number(it.price) || 0);
                sumTotal += v;
                const t = (it.type || '').toLowerCase();
                if (t.includes('ăn') || t.includes('ăn uống') || t.includes('an')) sumFood += v;
                else if (t.includes('điện') || t.includes('dien')) sumElectric += v;
                else if (t.includes('nước') || t.includes('nuoc')) sumWater += v;
                else if (t.includes('phòng') || t.includes('phong') || t.includes('tiền phòng')) sumRent += v;
            });
            document.getElementById('sumFood').textContent = fmt(sumFood, currency);
            document.getElementById('sumElectric').textContent = fmt(sumElectric, currency);
            document.getElementById('sumWater').textContent = fmt(sumWater, currency);
            document.getElementById('sumRent').textContent = fmt(sumRent, currency);
            document.getElementById('sumTotal').textContent = fmt(sumTotal, currency);

            // per-day calculation
            if (validateDates()) {
                const sd = new Date(document.getElementById('startDate').value);
                const ed = new Date(document.getElementById('endDate').value);
                const days = Math.floor((ed - sd) / (1000 * 60 * 60 * 24)) + 1;
                if (days > 0) {
                    const perDay = sumTotal / days;
                    document.getElementById('perDayText').textContent = `Trung bình ${fmt(perDay, currency)} / ngày (${days} ngày từ ${sd.toLocaleDateString()} đến ${ed.toLocaleDateString()})`;
                } else document.getElementById('perDayText').textContent = '';
            } else document.getElementById('perDayText').textContent = '';
        }

        // initial: add a couple of example rows
        items.push({ type: 'Ăn uống', desc: 'Ăn trưa', qty: 20, price: 40000, note: 'Tháng 12', currency: 'VND', date: '' });
        items.push({ type: 'Tiền phòng', desc: 'Phòng trọ tháng 12', qty: 1, price: 3000000, note: 'Thanh toán 01/12/2025', currency: 'VND', date: '' });
        items.push({ type: 'Điện', desc: 'Điện tháng 12', qty: 1, price: 250000, note: 'Hóa đơn', currency: 'VND', date: '' });
        render(); calculateSums();

    </script>
</body>

</html>